$(document).ready(() => {
    $("#Accept").on("submit", submit);
});

function submit(event) {
    event.preventDefault();
    $("#progressText").html("Trwa akceptacja...");
    $("#progressBar").removeClass("d-none");
    $("#Accept input[type='submit']").prop("disabled", true);
    $.ajax({
        type: "POST",
        url: "/Transaction/Accept",
        data: $("#Accept").serialize()
    }).done((response) => {
        if (response == 1) {
            $("#progressBar").addClass("d-none");
            $("#invalidAlert").addClass("d-none");
            $("#successAlert").removeClass("d-none");
            setTimeout(() => {
                $("#successAlert").addClass("d-none");
            }, 5000);
        }
        else {
            $("#Accept input[type='submit']").prop("disabled", false);
            $("#progressBar").addClass("d-none");
            $("#invalidAlert").removeClass("d-none");
            $("#successAlert").addClass("d-none");
            setTimeout(() => {
                $("#invalidAlert").addClass("d-none");
            }, 5000);
        }
    });
}
$(document).ready(function () {
    $("#FromDate").datepicker({
        language: 'pl-PL',
        format: 'yyyy-mm-dd',
        autoHide: true,
        autoPick: true,
        highlightedClass: "highlighted",
        startDate: Date.now()
    });
});

$(document).ready(function () {
    $("#ToDate").datepicker({
        language: 'pl-PL',
        format: 'yyyy-mm-dd',
        autoHide: true,
        autoPick: true,
        highlightedClass: "highlighted",
        startDate: Date.now()
    });
});

$(document).ready(() => {
    $("#FromDate").on("pick.datepicker", function (e) {
        if (e.date > $("#ToDate").datepicker("getDate")) {
            $("#FromDate").datepicker("setDate", $("#ToDate").datepicker("getDate"));
        }
    });
    $("#ToDate").on("pick.datepicker", function (e) {
        if (e.date < $("#FromDate").datepicker("getDate")) {
            $("#ToDate").datepicker("setDate", $("#FromDate").datepicker('getDate'));
        }
    });
});
function generatePdf(transactionCode) {
    $("#generatingPDF").removeClass("d-none");
    $.get(`/Transaction/generatepdf/${transactionCode}`)
        .done((Response) => {
            var link = document.createElement("a");
            link.download = Response;
            link.href = Response;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            delete link;
            $("#generatingPDF").text("Pobieranie...");
            setTimeout(function () {
                $("#generatingPDF").addClass("d-none");
                $("#generatingPDF").text("Generowanie PDF...");
            }, 4000);
        })
        .fail((error) => {
            console.error(error);
        });
   
}
$(document).ready(() => {
    $.ajax({
        type: "GET",
        dataType: "json",
        data: {},
        url: "/PlatformBankAccount/GetBank"
    }).done((response) => {
        $.each(response, index => {
            $("#BankName").append(`<option value="${response[index].name}">${response[index].name}</option>`);
        });
        let bankName = $("#BankName").val();
        $.ajax({
            type: "GET",
            dataType: "json",
            data: { bankName: bankName },
            url: "/PlatformBankAccount/GetCurrency"
        }).done((response) => {
            $.each(response, index => {
                $("#CurrencyName").append(`<option value="${response[index].symbol}">${response[index].symbol} - ${response[index].name}</option>`);
            });
        });
    });
});
$(document).ready(() => {
    $("#Search #PersonalCode").keyup(() => {
        let personalCode = $("#PersonalCode").val();
        if (personalCode.length > 4) {
            $("#Search #progressText").html("Trwa wyszukiwanie...");
            $("#Search #progressBar").removeClass("d-none");
            $.ajax({
                type: "POST",
                data: $("#Search").serialize(),
                url: "/Transaction/GetContractor",
                dataType: "html"
            }).done((response) => {
                $("#contractor").html(response);
                $("#Search #progressBar").addClass("d-none");
            });
        }
        else {
            $("#contractor").empty();
            $("#Search #progressBar").addClass("d-none");
        }
    });
});
$(document).ready(() => {
    $("#BankName").change(() => {
        let bankName = $("#BankName").val();
        $.ajax({
            type: "GET",
            dataType: "json",
            data: { bankName: bankName },
            url: "/PlatformBankAccount/GetCurrency"
        }).done((response) => {
            $("#CurrencyName").empty();
            $.each(response, index => {
                $("#CurrencyName").append(`<option value="${response[index].symbol}">${response[index].symbol} - ${response[index].name}</option>`);
            });
        });
    });
});
$(document).ready(() => {
    $("#progressText").html("Trwa pobieranie danych...");
    $("#progressBar").removeClass("d-none");
    $("#Accept input[type='submit']").prop("disabled", true);
    let url = window.location.pathname;
    let id = url.substring(url.lastIndexOf('/') + 1);
    $.ajax({
        type: "GET",
        dataType: "json",
        data: { id: id },
        url: "/Transaction/GetDetails"
    }).done((response) => {
        $("#Id").val(response.id);

        var dateOfOrder = FormatDate(response.dateOfOrder);
        $("#DateOfOrder").text(dateOfOrder);
        $("#TransactionCode").text(response.transactionCode);
        $("#Customer").text(response.customer);
        $("#Contractor").text(response.contractor);
        $("#Name").text(response.name);

        var fromDate = FormatDate(response.fromDate);
        $("#FromDate").text(fromDate);

        var toDate = FormatDate(response.toDate);
        $("#ToDate").text(toDate);

        $("#Currency").text(response.currency);

        var amount = response.amount.toFixed(2);
        amount = amount.toString().replace(".", ",");
        $("#Amount").text(amount);

        $("#Description").text(response.description);
        $("#Accept input[type='submit']").prop("disabled", false);
        $("#warningAlert").addClass("d-none");
        $("#progressBar").addClass("d-none");
    }).fail(function () {
        $("#warningAlert").removeClass("d-none");
        setTimeout(() => {
            $("#warningAlert").addClass("d-none");
        }, 10000);
        $("#progressBar").addClass("d-none");
    });
});

function FormatDate(date) {
    date = new Date(date);
    console.log(date);
    var year = date.getFullYear();
    var month = (1 + date.getMonth()).toString();
    month = month.length > 1 ? month : '0' + month;
    var day = date.getDate().toString();
    day = day.length > 1 ? day : '0' + day;
    return year + "-" + month + "-" + day;
}
$(document).ready(() => {
    $("#progressText").html("Trwa pobieranie danych...");
    $("#progressBar").removeClass("d-none");
    $("#Accept input[type='submit']").prop("disabled", true);
    let url = window.location.pathname;
    let id = url.substring(url.lastIndexOf('/') + 1);
    $.ajax({
        type: "GET",
        dataType: "json",
        data: { id: id },
        url: "/Transaction/GetDetails"
    }).done((response) => {
        $("#Id").val(response.id);

        var dateOfOrder = FormatDate(response.dateOfOrder);
        $("#DateOfOrder").text(dateOfOrder);
        $("#TransactionCode").text(response.transactionCode);
        $("#Customer").text(response.customer);
        $("#Contractor").text(response.contractor);
        $("#Name").text(response.name);

        var fromDate = FormatDate(response.fromDate);
        $("#FromDate").text(fromDate);

        var toDate = FormatDate(response.toDate);
        $("#ToDate").text(toDate);

        $("#Currency").text(response.currency);

        var amount = response.amount.toFixed(2);
        amount = amount.toString().replace(".", ",");
        $("#Amount").text(amount);

        $("#Description").text(response.description);
        $("#Accept input[type='submit']").prop("disabled", false);
        $("#warningAlert").addClass("d-none");
        $("#progressBar").addClass("d-none");
    }).fail(function () {
        $("#warningAlert").removeClass("d-none");
        setTimeout(() => {
            $("#warningAlert").addClass("d-none");
        }, 10000);
        $("#progressBar").addClass("d-none");
    });
});

function FormatDate(date) {
    date = new Date(date);
    console.log(date);
    var year = date.getFullYear();
    var month = (1 + date.getMonth()).toString();
    month = month.length > 1 ? month : '0' + month;
    var day = date.getDate().toString();
    day = day.length > 1 ? day : '0' + day;
    return year + "-" + month + "-" + day;
}